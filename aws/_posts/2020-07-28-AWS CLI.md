---
layout: post
title: AWS CLI ,SDK, IAM roles
description: >
  CLI
excerpt_separator: <!--more-->
---

# AWS CLI ,SDK, IAM roles

# CLI

## Setup

AWS CLI 를 window에서 사용하는 법은 간단하다. 여기서 [https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-windows.html](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-windows.html) aws에서 MSI installer 로 설치하면 된다. 

그 후 cmd에서 aws --version 하면 이렇게 뜬다.

![CLI_setup](https://user-images.githubusercontent.com/37058233/95748289-bd180480-0cd4-11eb-86a8-296ee76e964f.PNG)



## CLI installation Troubleshooting

  aws:command not found
    the aws executable 이 PATH env variable에 없다.
    (PATH 는 너의 aws 실행파일이 어디있는지 시스템에게 알려주는 역할을 한다.)


## AWS CLI configuration

- ### 개인컴일 때

IAM 서비스에서 users  => security credentials 가서 create access key. 

![createAccessKey](https://user-images.githubusercontent.com/37058233/95749732-00737280-0cd7-11eb-82b5-7439e537bd6e.PNG)

download .csv file 한다. 이 파일은 super secret임.

![download](https://user-images.githubusercontent.com/37058233/95749778-11bc7f00-0cd7-11eb-8650-ca417258a960.PNG)

*주의 !  절대 ec2 머신에서 하지 말것. ec2 머신에 personal credentials 넣는거 안좋다.*



command line 에서 aws configure 치면, 다음을 차례로 입력해 주면 된다.

```
AWS Access Key ID [None] : [여기 access key 입력]
AWS secret Access Key ID [None] : [여기 secret access key 입력]
Default region name [None] : [여기 region 입력]
```



- ### EC2 instance 일 때

앞서 한 것 처럼하면 아주 큰일 난다. EC2 Instance에 이런 중요한 정보 업로드하면 안된다. 대신, IAM ROLE을 이용한다.

ec2 머신에 ssh 접속한다. 
aws configure

```
AWS Access Key ID [None] : [엔터]
AWS secret Access Key ID [None] : [엔터]
Default region name [None] : [여기 region 입력]
```

IAM 롤에 가서 , create role 한다. aws service => ec2 => policy 찾는다. 

![iam role](https://user-images.githubusercontent.com/37058233/95750685-788e6800-0cd8-11eb-8fe6-f0409d915b05.PNG)



내가 만약 이 ec2 instance에 s3 에 접속 권한을 주고 싶으면, AmazonS3ReadOnlyAccess를 선택하고
role name과 description 써준다.  그리고 next 누르면 끝. 



Policy 생성해서 role에 부착한다. 그 role을 ec2에 부착한다. 

![policyRole](https://user-images.githubusercontent.com/37058233/95863773-8c50d180-0d9f-11eb-9b00-d0661de8f220.PNG)

EC2 management 콘솔에 가서 instance setting, attach/replace IAM role 에서 내가 방금 만든 role을 attach 해준다. 

![iam role](https://user-images.githubusercontent.com/37058233/95860452-05015f00-0d9b-11eb-8bdf-6265e848e870.PNG)

그럼 해결~~~



## IAM Roles & Policies 실습

inline policy : 그냥 그 역할을 위해 사용한다. 다른 객체한테 부착불가. 추천하지 않는다.

AWS Simulator 검색해서 들어가면, policy simulator 에서 권한 확인 가능 [https://policysim.aws.amazon.com/home/index.jsp](https://policysim.aws.amazon.com/home/index.jsp)

## Dry Run 

```aws
 aws ec2 run-instances --dry-run --image-id [ami-아이디입력] --instance-type t2.micro
```

![dryrun](https://user-images.githubusercontent.com/37058233/95860426-ff0b7e00-0d9a-11eb-856a-d39253135541.PNG)

ec2에서 내 계정이랑 연결을 안해서 오류가 났다. 

admin role을 attach 해주고 돌리면 제대로 된다. 

![](https://user-images.githubusercontent.com/37058233/95860450-0468c880-0d9b-11eb-8010-1743985879c4.PNG)



## STS decoding

[https://docs.aws.amazon.com/cli/latest/reference/sts/decode-authorization-message.html](https://docs.aws.amazon.com/cli/latest/reference/sts/decode-authorization-message.html)

```
  decode-authorization-message
--encoded-message <value>
[--cli-input-json <value>]
[--generate-cli-skeleton <value>]
```

이걸 사용하기 위해서 STS decode 권한을 부여해야한다. Policy에서 설정한 후, 이 policy를 내 ec2 instance에 붙어있는 role에 추가한다.

![sts폴리시](https://user-images.githubusercontent.com/37058233/95863879-aab6cd00-0d9f-11eb-930c-4c37b87a6917.PNG)



![add](https://user-images.githubusercontent.com/37058233/95863882-abe7fa00-0d9f-11eb-9b6e-c9e911fbbcb1.PNG)

권한 설정을 마쳤으면, 다음과 같이 돌리면 된다. 

```
aws sts decode-authorization-message --encoded-message
```



![STS에러메세지 decode](https://user-images.githubusercontent.com/37058233/95863567-501d7100-0d9f-11eb-84a3-537697891f51.PNG)

JSON 형식으로 정보가 DECODE된다.

