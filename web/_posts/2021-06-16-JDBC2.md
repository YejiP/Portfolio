# JDBC - CRUD 구현하기

- 전체적 구조는 [이전 포스트](https://yejip.com/web/2021-06-14-JDBC1/) 참고 
- try catch 문이 아주 많이 사용됐다. 
- Retrieve는 Role객체를 반환해 주지만, Create,Update,Delete는 몇개가 수행되었는지 숫자정보가 반환된다. 
- 전체코드는 아주 맨 아래에...

## Create 

- **RoleDao.java**

  ```java
  public int addRole(Role role) {
      int insertCount =0;
      //드라이버 로드
      try {
          Class.forName("com.mysql.jdbc.Driver");
      }catch(ClassNotFoundException e){
          e.printStackTrace();
      }
  
      String sql="INSERT INTO role (role_id,description) VALUES(?,?)";
      //여기 try catch문 신기
      try(Connection conn = DriverManager.getConnection(dburl, dbUser, dbpasswd);
          PreparedStatement ps = conn.prepareStatement(sql)) {
          ps.setInt(1, role.getRoleId());
          ps.setString(2,role.getDescription());
          insertCount = ps.executeUpdate();
      }catch(Exception ex) {
          ex.printStackTrace();
      }
      return insertCount;
  }
  ```

- **JDBCExam4.java**

  ```java
  package kr.or.connect.jdbcexam;
  import kr.or.connect.jdbcexam.dao.RoleDao;
  import kr.or.connect.jdbcexam.dto.Role;
  public class JDBCExam2 {
      public static void main(String[] args) {
          int roleId = 501;
          String description = "CTO";
          Role role = new Role(roleId, description);
          RoleDao dao = new RoleDao();
          int insertCount = dao.addRole(role);
          System.out.println(insertCount);
      }
  }
  ```

## Retrieve - One Item

- **RoleDao.java**

  ```java
  public int addRole(Role role) {
      int insertCount =0;
      //드라이버 로드
      try {
          Class.forName("com.mysql.jdbc.Driver");
      }catch(ClassNotFoundException e){
          e.printStackTrace();
      }
      String sql="INSERT INTO role (role_id,description) VALUES(?,?)";
      try(Connection conn = DriverManager.getConnection(dburl, dbUser, dbpasswd);
          PreparedStatement ps = conn.prepareStatement(sql)) {
          ps.setInt(1, role.getRoleId());
          ps.setString(2,role.getDescription());
          insertCount = ps.executeUpdate();
      }catch(Exception ex) {
          ex.printStackTrace();
      }
      return insertCount;
  }
  
  ```

- **JDBCExample1.java**

  ```java
  package kr.or.connect.jdbcexam;
  import kr.or.connect.jdbcexam.dao.RoleDao;
  import kr.or.connect.jdbcexam.dto.Role;
  public class JDBCExam1 {
      public static void main(String[] args) {
          RoleDao dao = new RoleDao();
          Role role = dao.getRole(100);
          System.out.println(role);		
      }
  }
  ```

## Retrieve - Items

- **RoleDao.java**

  ```java
  public List<Role> getRoles(){
      List<Role> list = new ArrayList<>();
      try {
          Class.forName("com.mysql.jdbc.Driver");
      }catch(ClassNotFoundException e){
          e.printStackTrace();
      }
      String sql = "SELECT description,role_id FROM role order by role_id desc";
      try(Connection conn = DriverManager.getConnection(dburl,dbUser,dbpasswd);
          PreparedStatement ps = conn.prepareStatement(sql)){
          //try문 안에 또 try문이 있다.
          try(ResultSet rs = ps.executeQuery()){
              while(rs.next()) {
                  String description = rs.getString(1);
                  int id=rs.getInt("role_id");
                  Role role = new Role(id,description);
                  list.add(role);
              }
          }catch(Exception e){
              e.printStackTrace();
          }
      }catch(Exception ex) {
          ex.printStackTrace();
      }
      return list;
  }
  ```

- **JDBCExam3.java**

  ```java
  package kr.or.connect.jdbcexam;
  import java.util.List;
  import kr.or.connect.jdbcexam.dao.RoleDao;
  import kr.or.connect.jdbcexam.dto.Role;
  public class JDBCExam3 {
      public static void main(String[] args) {
          RoleDao dao=new RoleDao();
          List<Role> list = dao.getRoles();
          for(Role role : list) {
              System.out.println(role);
          }
      }
  }
  ```

## Update

- **RoleDao.java**

  ```java
  public int updateRole(Role role) {
      int updateCount =0;
      Connection conn=null;
      PreparedStatement ps = null;
      try {
          Class.forName("com.mysql.jdbc.Driver");
          conn=DriverManager.getConnection(dburl,dbUser,dbpasswd);
          String sql="UPDATE ROLE SET DESCRIPTION = ? WHERE role_id =?";
          ps = conn.prepareStatement(sql);
          ps.setString(1,role.getDescription());
          ps.setInt(2, role.getRoleId());
          updateCount=ps.executeUpdate();
      }catch(Exception ex) {
          ex.printStackTrace();
      }finally {
          if(ps!=null) {
              try {
                  ps.close();
              }catch(Exception ex) {
  
              }
          }
          if(conn!=null) {
              try {
                  conn.close();
              }catch(Exception ex) {}
          }
      }
      return updateCount;
  }
  ```

- **JDBCExam5.java**

  ```java
  package kr.or.connect.jdbcexam;
  import kr.or.connect.jdbcexam.dao.RoleDao;
  import kr.or.connect.jdbcexam.dto.Role;
  public class JDBCExam5 {
  	public static void main(String[] args) {
  		int roleId = 501;
  		String description ="ECO";
  		Role role = new Role(roleId,description);
  		RoleDao dao=new RoleDao();
  		int updateCount = dao.updateRole(role);	
  		System.out.println(updateCount);
  	}
  }
  ```

## Delete

- **RoleDao.java**

  ```java
  public int deleteRole(int roleId) {
      int deleteCount = 0;
      Connection conn=null;
      PreparedStatement ps = null;
      try {
          Class.forName("com.mysql.jdbc.Driver");
          conn = DriverManager.getConnection(dburl,dbUser,dbpasswd);
          String sql = "DELETE FROM role WHERE role_id=?";
          ps = conn.prepareStatement(sql);
          ps.setInt(1, roleId);
          deleteCount = ps.executeUpdate();
      }catch(Exception ex){
          ex.printStackTrace();
      }finally {
          if(ps!=null) {
              try {
                  ps.close();
              }catch(Exception ex) {
              }
          }
      }
      return deleteCount;
  }
  ```

- **JDBCExam4.java**

  ```java
  package kr.or.connect.jdbcexam;
  import kr.or.connect.jdbcexam.dao.RoleDao;
  public class JDBCExam4 {
      public static void main(String[] args) {
          int roleId = 500;
          RoleDao dao= new RoleDao();
          int deleteCount = dao.deleteRole(roleId);
          System.out.println(deleteCount);
      }
  }
  ```

# 전체 코드

**Role.java**

```java
package kr.or.connect.jdbcexam.dto;

public class Role {
    private Integer roleId;
    private String description;

    public Role(Integer roleId, String description) {
        super();
        this.roleId = roleId;
        this.description = description;
    }

    public Integer getRoleId() {
        return roleId;
    }

    public void setRoleId(Integer roleId) {
        this.roleId = roleId;
    }
    public String getDescription() {
        return description;
    }
    public void setDescription(String description) {
        this.description = description;
    }
    @Override
    public String toString() {
        return "Role [roleId=" + roleId + ", description=" + description + "]";
    }
}
```

**RoleDao.java**

```java
package kr.or.connect.jdbcexam.dao;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.sql.Connection;
import java.sql.PreparedStatement;

import kr.or.connect.jdbcexam.dto.Role;

public class RoleDao {
    private static String dburl = "jdbc:mysql://localhost:3306/cutePin?serverTimezone=Asia/Seoul&useSSL=false";
    private static String dbUser = "callie";
    private static String dbpasswd = "connect123!@#";

    public Role getRole(Integer roleId) {
        Role role = null;
        Connection conn =null;
        PreparedStatement ps =null;
        ResultSet rs = null;

        try {
            //load the driver to memory?
            Class.forName("com.mysql.jdbc.Driver");
            conn = DriverManager.getConnection(dburl,dbUser,dbpasswd);
            //? 에 다른게 들어갈 수 있다. set 으로 설정할 수 있음
            String sql = "SELECT  role_id,description FROM role WHERE role_id =?";
            //
            ps=conn.prepareStatement(sql);
            ps.setInt(1, roleId);
            rs = ps.executeQuery();
            // 있으면, 객체 리턴. 없으면  false리턴
            if(rs.next()) {
                int id=  rs.getInt(1);//rs.getInt("role_id"); 이렇게 해도 된다. 
                String description = rs.getString(2);
                role = new Role(id,description);
            }
        }catch(Exception e){
            e.printStackTrace();
        }finally{
            if(conn!=null) {
                try {
                    conn.close();
                } catch (SQLException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
            }
            if(ps!=null) {
                try {
                    ps.close();
                } catch (SQLException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
            }
            if(rs!=null) {
                try {
                    rs.close();
                } catch (SQLException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
            }
        }

        return role;

    }

    public int addRole(Role role) {
        int insertCount =0;
        //드라이버 로드
        try {
            Class.forName("com.mysql.jdbc.Driver");
        }catch(ClassNotFoundException e){
            e.printStackTrace();
        }

        String sql="INSERT INTO role (role_id,description) VALUES(?,?)";
        //여기 try catch문 신기
        try(Connection conn = DriverManager.getConnection(dburl, dbUser, dbpasswd);
            PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, role.getRoleId());
            ps.setString(2,role.getDescription());
            insertCount = ps.executeUpdate();
        }catch(Exception ex) {
            ex.printStackTrace();
        }

        return insertCount;
    }

    public List<Role> getRoles(){
        List<Role> list = new ArrayList<>();
        //driver 다운로드
        try {
            Class.forName("com.mysql.jdbc.Driver");
        }catch(ClassNotFoundException e){
            e.printStackTrace();
        }

        String sql = "SELECT description,role_id FROM role order by role_id desc";
        //위에서 받은 driver manager에서 Connection  객체를 받고, Connection 객체에서  preparedStatement 객체를 받는다.	
        try(Connection conn = DriverManager.getConnection(dburl,dbUser,dbpasswd);
            PreparedStatement ps = conn.prepareStatement(sql)){
            //try문 안에 또 try문이 있다.
            try(ResultSet rs = ps.executeQuery()){
                while(rs.next()) {
                    String description = rs.getString(1);
                    int id=rs.getInt("role_id");
                    Role role = new Role(id,description);
                    list.add(role);
                }
            }catch(Exception e){
                e.printStackTrace();
            }

        }catch(Exception ex) {
            ex.printStackTrace();
        }

        return list;
    }

    public int deleteRole(int roleId) {
        int deleteCount = 0;
        Connection conn=null;
        PreparedStatement ps = null;

        try {
            Class.forName("com.mysql.jdbc.Driver");

            conn = DriverManager.getConnection(dburl,dbUser,dbpasswd);
            String sql = "DELETE FROM role WHERE role_id=?";
            ps = conn.prepareStatement(sql);
            ps.setInt(1, roleId);
            deleteCount = ps.executeUpdate();
        }catch(Exception ex){
            ex.printStackTrace();
        }finally {
            if(ps!=null) {
                try {
                    ps.close();
                }catch(Exception ex) {

                }
            }
        }

        return deleteCount;
    }

    public int updateRole(Role role) {
        int updateCount =0;
        Connection conn=null;
        PreparedStatement ps = null;
        try {
            Class.forName("com.mysql.jdbc.Driver");
            conn=DriverManager.getConnection(dburl,dbUser,dbpasswd);
            String sql="UPDATE ROLE SET DESCRIPTION = ? WHERE role_id =?";
            ps = conn.prepareStatement(sql);
            ps.setString(1,role.getDescription());
            ps.setInt(2, role.getRoleId());
            updateCount=ps.executeUpdate();
        }catch(Exception ex) {
            ex.printStackTrace();
        }finally {
            if(ps!=null) {
                try {
                    ps.close();
                }catch(Exception ex) {

                }
            }

            if(conn!=null) {
                try {
                    conn.close();
                }catch(Exception ex) {}
            }
        }

        return updateCount;
    }
}

```

