<?php
session_start();
$success ="";

if(array_key_exists('email',$_POST) AND array_key_exists('pwd',$_POST)){

  $link = mysqli_connect("localhost","travis5_callie" ,"L3tsl3arn","travis5_callie");
//커넥션 에러나면 죽임
  if(mysqli_connect_error()){
      $success= "There was an error connecting to the database";
      die("There was an error connecting to the database");
  }
  //sign up인지 log in 인지에 따라 다른 작업 수행(쿼리문 달라짐)
echo $_POST['type'];
  if($_POST['type']=="log"){
    $query="SELCET * FROM `users` WHERE email='".mysqli_real_escape_string($link,$_POST['email'])."'AND password='".mysqli_real_escape_string($link,$_POST['pwd'])."'";
    if (mysqli_query($link,$query)){
    $_SESSION['email'] =$_POST['email'];
    header("Location: ../session.php");
}else{
   $success= "<p>There was a problem logging in - please try again later.</p>";
}
  }
  if($_POST['type']=="sign"){
    $query="SELCET * FROM `users` WHERE email='".mysqli_real_escape_string($link,$_POST['email'])."'";
    if(mysqli_query($link,$query)){
$success ="This ID is already taken. Please try other";
}else{
    $query= "INSERT INTO `users` (`email`,`password`) VALUES ('".mysqli_real_escape_string($link,$_POST['email'])."','".mysqli_real_escape_string($link,$_POST['pwd'])."')";
    if (mysqli_query($link,$query)){
    $_SESSION['email'] =$_POST['email'];
    header("Location: ../session.php");}else{
    echo "<p>There was a problem signing you up - please try again later.</p>";
}
  }
}}

?>

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Secret Diary</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <style>
    html{
    height:100%;
    }
    body{
      background-image: url("https://images.unsplash.com/photo-1444080748397-f442aa95c3e5?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1190&q=80");
      background-repeat: no-repeat;
      background-size: cover ;
      height:100%;
      padding:10%;

    }
    </style>

    <script>
      $(function(){
        $("#choice").click(function(){

          var temp=$("#go").text();
          $("#go").text($(this).text());
          $(this).text(temp);
          if($(this).text()=="Log In!"){
            $("#toggleText").text("Log in using your username and password.");
            $("#go").val("log");

          }else{
            $("#toggleText").text("Interested? Sign up now.")
            $("#go").val("sign");

          }
        })

        $("#go").click(function(){
          var ok=true;
          var warn="";
          //빠진것만 validation. db 조회는 php로 넘긴다.
          if($("#email").val()==""){
            ok=false;
            warn+="Email is required.<br>";
          }
          if($("#pwd").val()==""){
            ok=false;
            warn+="Password is required";
          }
          warn+='<?php echo "$success"; ?>';
          $("#warning").html(warn);

          //if all good, then form submit
          if(ok){
            $("form").submit();
          }


        })


      })

    </script>
  </head>
  <body>
    <div class="container col-4 align-self-center" style="text-align:center;color:white; min-width:500px">
  <h1>Secret Diary</h1>
  <p class="lead font-weight-bold">Store your thoughts permanantly and securely.</p>
  <div class="alert alert-danger"id="warning" role="alert"><?php echo $success; ?></div>
  <p id="toggleText">Interested? Sign up now.</p>
  <form method="POST">
  <p>
    <input type="email" id="email" name="email" class="form-control" placeholder="Your Email">
    <input type="password" id="pwd" name="pwd" class="form-control" placeholder="Password" >
  </p>
  <p class="lead">
      <label>
        <input type="checkbox">&nbsp;Stay logged in</label>
    <p><a class="btn btn-success btn-lg" id="go"  role="button">Sign Up!</a></p>
    <p><a class="btn btn-link btn-lg font-weight-bold" id="choice" href="#" role="button">Log In!</a></p>
    <input type="hidden" name="type">&nbsp;Stay logged in</label>

  </p>
</form>
</div>
<script>

  if(array_key_exists('email',$_POST) AND array_key_exists('pwd',$_POST)){

    $link = mysqli_connect("localhost","travis5_callie" ,"L3tsl3arn","travis5_callie");
  //커넥션 에러나면 죽임
    if(mysqli_connect_error()){
        $success= "There was an error connecting to the database";
        die("There was an error connecting to the database");
    }
    //sign up인지 log in 인지에 따라 다른 작업 수행(쿼리문 달라짐)
    if($_POST['what']=="log"){

    $query = sprintf("SELECT email FROM users
    WHERE email='%s' AND password='%s'",
    mysqli_real_escape_string($link,$_POST['email']),
    mysqli_real_escape_string($link,$_POST['pwd']));
      //$query="SELCET * FROM `users` WHERE email='".mysqli_real_escape_string($link,$_POST['email'])."'AND password='".mysqli_real_escape_string($link,$_POST['pwd'])."'";
       $result=mysqli_query($link,$query);
     if (mysqli_num_rows($result)>0){
      $_SESSION['email'] =$_POST['email'];
      header("Location: ../session.php");
  }else{
     $success= "<p>There was a problem logging in - please try again later.</p>";
  }
    }
    if($_POST['what']=="sign"){
      $query="SELCET * FROM `users` WHERE email='".mysqli_real_escape_string($link,$_POST['email'])."'";
       $result=mysqli_query($link,$query);
      if(mysqli_num_rows($result)>0){
  $success ="This ID is already taken. Please try other";
  }else{
      $query= "INSERT INTO `users` (`email`,`password`) VALUES ('".mysqli_real_escape_string($link,$_POST['email'])."','".mysqli_real_escape_string($link,$_POST['pwd'])."')";
      if (mysqli_query($link,$query)){
      $_SESSION['email'] =$_POST['email'];
      header("Location: ../session.php");
  }else{
      echo "<p>There was a problem signing you up - please try again later.</p>";
  }
    }
  }}
</script>
  </body>
</html>
